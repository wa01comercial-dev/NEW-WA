<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WA Comercial | Growth Command Center</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- SortableJS (Adicionado para Drag and Drop) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Configura√ß√£o de Cores e Tema -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: 'var(--bg-dark)',
                            panel: 'var(--bg-panel)',
                            accent: '#ef4444',
                            accentHover: '#dc2626',
                            text: 'var(--text-main)',
                            muted: 'var(--text-muted)',
                            success: '#10b981',
                            warning: '#f59e0b',
                            info: '#3b82f6'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Vari√°veis de Tema (Dark Mode Default) --- */
        :root {
            --bg-dark: #0f0f13;
            --bg-panel: #18181b;
            --text-main: #e4e4e7;
            --text-muted: #a1a1aa;
            --border-color: #1f2937; /* gray-800 */
            --input-bg: #111827; /* gray-900 */
        }

        /* --- Blue Light Mode --- */
        body.light-mode {
            --bg-dark: #f0f9ff; /* Alice Blue / Light Sky */
            --bg-panel: #ffffff;
            --text-main: #1e293b; /* Slate 800 */
            --text-muted: #64748b; /* Slate 500 */
            --border-color: #bfdbfe; /* Blue 200 */
            --input-bg: #f8fafc; /* Slate 50 */
        }

        /* Overrides espec√≠ficos para Light Mode para compatibilidade com classes Tailwind hardcoded */
        body.light-mode .text-white { color: #1e3a8a !important; } /* Texto branco vira azul escuro */
        body.light-mode .text-gray-400 { color: #64748b !important; }
        body.light-mode .text-gray-500 { color: #94a3b8 !important; }
        body.light-mode .bg-gray-800 { background-color: #dbeafe !important; } /* Badges viram azul claro */
        body.light-mode .bg-gray-900 { background-color: #eff6ff !important; border-color: #bfdbfe !important; color: #1e293b !important; } /* Inputs */
        body.light-mode .border-gray-800 { border-color: #bfdbfe !important; }
        body.light-mode .border-gray-700 { border-color: #cbd5e1 !important; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-panel); }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #ef4444; }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }

        .card-animado { transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: grab; } /* Cursor grab adicionado */
        .card-animado:active { cursor: grabbing; }
        .card-animado:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2); }
        
        /* Classe adicionada pelo Sortable enquanto arrasta */
        .sortable-ghost { opacity: 0.4; }
        .sortable-drag { cursor: grabbing; }

        /* Cores de borda lateral baseadas no Status (Sobrescrevendo classes anteriores) */
        .borda-status-realizando { border-left-color: #ef4444 !important; } /* Vermelho */
        .borda-status-entregue { border-left-color: #10b981 !important; } /* Verde */
        .borda-status-neutro { border-left-color: #3b82f6 !important; } /* Azul/Padr√£o */

        /* Cores de badge atualizadas */
        .bg-entregue { background-color: rgba(16, 185, 129, 0.1) !important; border: 1px solid rgba(16, 185, 129, 0.2); color: #10b981 !important; }
        /* Realizando agora √© vermelho */
        .bg-realizando { background-color: rgba(239, 68, 68, 0.1) !important; border: 1px solid rgba(239, 68, 68, 0.2); color: #ef4444 !important; }
        
        /* Ajuste badges light mode */
        body.light-mode .bg-entregue { background-color: #d1fae5 !important; border-color: #34d399 !important; color: #065f46 !important; }
        body.light-mode .bg-realizando { background-color: #fee2e2 !important; border-color: #f87171 !important; color: #991b1b !important; }

        /* Overlay para mobile quando sidebar aberta */
        #mobile-overlay.active { display: block; }
        
        /* Sidebar Transitions */
        #sidebar { transition: transform 0.3s ease-in-out; }
        #sidebar.mobile-open { transform: translateX(0); }
    </style>
</head>
<body class="bg-brand-dark text-brand-text font-sans antialiased overflow-hidden transition-colors duration-300">

    <!-- Input Invis√≠vel para Importa√ß√£o -->
    <input type="file" id="fileInput" accept=".json" class="hidden" onchange="handleFileImport(this)">

    <!-- Overlay Mobile -->
    <div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-10 hidden md:hidden glass"></div>

    <div class="flex h-screen">

        <!-- Sidebar -->
        <!-- Alterado para suportar toggle no mobile com transform -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-20 w-64 bg-brand-panel border-r border-[var(--border-color)] flex flex-col shadow-xl transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300">
            <div class="h-16 flex items-center px-6 border-b border-[var(--border-color)]">
                <div class="flex items-center gap-2 text-brand-accent font-bold text-2xl tracking-tighter">
                    <i class="fa-solid fa-rocket"></i>
                    <span>WA<span class="text-white">COMERCIAL</span></span>
                </div>
            </div>

            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <p class="px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Analytics</p>
                
                <button onclick="switchTab('dashboard'); toggleSidebar()" id="btn-dashboard" class="w-full flex items-center gap-3 px-4 py-3 bg-brand-accent/10 text-brand-accent rounded-lg border-l-4 border-brand-accent transition-all text-left">
                    <i class="fa-solid fa-chart-pie w-5"></i>
                    <span class="font-medium">Vis√£o Geral</span>
                </button>

                <button onclick="switchTab('clients'); toggleSidebar()" id="btn-clients" class="w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-brand-text hover:bg-gray-800/20 rounded-lg border-l-4 border-transparent transition-all text-left">
                    <i class="fa-solid fa-users w-5"></i>
                    <span class="font-medium">Gerenciar Clientes</span>
                </button>
                
                <p class="px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider mt-6 mb-2">Dados</p>
                <button onclick="document.getElementById('fileInput').click(); toggleSidebar()" class="w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-brand-text hover:bg-gray-800/20 rounded-lg transition-all text-left">
                    <i class="fa-solid fa-file-import w-5"></i>
                    <span>Importar JSON</span>
                </button>
                <button onclick="exportData(); toggleSidebar()" class="w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-brand-text hover:bg-gray-800/20 rounded-lg transition-all text-left">
                    <i class="fa-solid fa-file-export w-5"></i>
                    <span>Exportar JSON</span>
                </button>
                
                <p class="px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider mt-6 mb-2">Sistema</p>
                <button onclick="resetData(); toggleSidebar()" class="w-full flex items-center gap-3 px-4 py-3 text-red-400 hover:text-red-300 hover:bg-red-900/20 rounded-lg transition-all text-left mt-auto">
                    <i class="fa-solid fa-trash w-5"></i>
                    <span>Limpar Tudo</span>
                </button>
            </nav>

            <div class="p-4 border-t border-[var(--border-color)]">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-brand-accent to-purple-600 flex items-center justify-center font-bold text-white shadow-lg shadow-purple-900/50">
                        WA
                    </div>
                    <div>
                        <p class="text-sm font-medium text-brand-text">Administrador</p>
                        <p class="text-xs text-green-400">‚óè Online</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-brand-dark transition-colors duration-300">
            
            <!-- Header -->
            <header class="h-16 bg-brand-panel/80 backdrop-blur-md border-b border-[var(--border-color)] flex items-center justify-between px-6 sticky top-0 z-10 transition-colors duration-300">
                <!-- Bot√£o Toggle Mobile (Clicar no nome) -->
                <button onclick="toggleSidebar()" class="md:hidden text-brand-accent font-bold text-xl focus:outline-none active:scale-95 transition-transform flex items-center gap-2">
                    <i class="fa-solid fa-bars text-lg"></i> WA COMERCIAL
                </button>
                
                <div class="hidden md:flex items-center text-sm text-gray-400 gap-4">
                    <span id="currentDate"></span>
                    <span class="text-gray-600">|</span>
                    <span id="totalRecordsBadge" class="bg-gray-800 px-2 py-1 rounded text-xs text-white">0 Registros</span>
                </div>

                <div class="flex items-center gap-4">
                    <!-- BOT√ÉO TOGGLE THEME -->
                    <button onclick="toggleTheme()" class="w-8 h-8 rounded-full bg-gray-800 hover:bg-gray-700 flex items-center justify-center text-yellow-400 transition-all border border-gray-700" title="Alternar Tema">
                        <i id="themeIcon" class="fa-solid fa-sun"></i>
                    </button>

                    <!-- Bot√£o Novo Cliente Ajustado para Mobile -->
                    <!-- Antes: hidden md:flex -->
                    <!-- Agora: flex (vis√≠vel sempre), texto escondido no mobile (hidden sm:inline) -->
                    <button onclick="abrirModalNovoCliente()" class="flex bg-brand-accent hover:bg-brand-accentHover text-white px-3 py-2 rounded-md text-sm font-bold shadow-lg shadow-red-900/20 transition-all items-center gap-2">
                        <i class="fa-solid fa-plus"></i> <span class="hidden sm:inline">Novo Cliente</span>
                    </button>

                    <div class="relative group cursor-pointer hidden sm:block">
                        <i class="fa-solid fa-bell text-gray-400 hover:text-brand-text text-lg"></i>
                        <span class="absolute -top-1 -right-1 w-2 h-2 bg-brand-accent rounded-full animate-pulse"></span>
                    </div>
                </div>
            </header>

            <!-- CONTAINER PRINCIPAL -->
            <div class="flex-1 overflow-y-auto p-6 relative">

                <!-- DASHBOARD -->
                <div id="view-dashboard" class="tab-content active space-y-6">
                    <div class="flex justify-between items-end animate-fade-in">
                        <div>
                            <h1 class="text-3xl font-bold text-brand-text mb-1">Painel de Controle</h1>
                            <p class="text-brand-muted">Indicadores em tempo real.</p>
                        </div>
                        <div class="text-xs text-gray-500 font-mono">
                            <i class="fa-solid fa-database text-brand-accent"></i> Conectado: Firebase Realtime
                        </div>
                    </div>

                    <!-- Cards Temporais -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 animate-fade-in">
                        <div class="bg-brand-panel p-4 rounded-xl border border-[var(--border-color)] shadow hover:border-red-400/50 transition-all group">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-400 text-xs font-semibold mb-1">Hoje</p>
                                    <h3 class="text-2xl font-bold text-brand-text" id="cardTodayCount">0</h3>
                                    <p class="text-xs text-gray-500 mt-1" id="cardTodayValue">R$ 0,00</p>
                                </div>
                                <div class="p-2 bg-red-500/10 rounded-lg text-red-500 group-hover:bg-red-500 group-hover:text-white transition-colors"><i class="fa-regular fa-calendar-check"></i></div>
                            </div>
                        </div>
                        <div class="bg-brand-panel p-4 rounded-xl border border-[var(--border-color)] shadow hover:border-teal-400/50 transition-all group">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-400 text-xs font-semibold mb-1">Ontem</p>
                                    <h3 class="text-2xl font-bold text-brand-text" id="cardYesterdayCount">0</h3>
                                    <p class="text-xs text-gray-500 mt-1" id="cardYesterdayValue">R$ 0,00</p>
                                </div>
                                <div class="p-2 bg-teal-500/10 rounded-lg text-teal-500 group-hover:bg-teal-500 group-hover:text-white transition-colors"><i class="fa-regular fa-calendar-minus"></i></div>
                            </div>
                        </div>
                        <div class="bg-brand-panel p-4 rounded-xl border border-[var(--border-color)] shadow hover:border-emerald-400/50 transition-all group">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-400 text-xs font-semibold mb-1">Essa Semana</p>
                                    <h3 class="text-2xl font-bold text-brand-text" id="cardWeekCount">0</h3>
                                    <p class="text-xs text-gray-500 mt-1" id="cardWeekValue">R$ 0,00</p>
                                </div>
                                <div class="p-2 bg-emerald-500/10 rounded-lg text-emerald-500 group-hover:bg-emerald-500 group-hover:text-white transition-colors"><i class="fa-regular fa-calendar-plus"></i></div>
                            </div>
                        </div>
                        <div class="bg-brand-panel p-4 rounded-xl border border-[var(--border-color)] shadow hover:border-blue-400/50 transition-all group">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-400 text-xs font-semibold mb-1">M√™s Atual</p>
                                    <h3 class="text-2xl font-bold text-brand-text" id="cardMonthCount">0</h3>
                                    <p class="text-xs text-gray-500 mt-1" id="cardMonthValue">R$ 0,00</p>
                                </div>
                                <div class="p-2 bg-blue-500/10 rounded-lg text-blue-500 group-hover:bg-blue-500 group-hover:text-white transition-colors"><i class="fa-regular fa-calendar"></i></div>
                            </div>
                        </div>
                        <div class="bg-brand-panel p-4 rounded-xl border border-[var(--border-color)] shadow hover:border-yellow-400/50 transition-all group">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-400 text-xs font-semibold mb-1">Semana Passada</p>
                                    <h3 class="text-2xl font-bold text-brand-text" id="cardLastWeekCount">0</h3>
                                    <p class="text-xs text-gray-500 mt-1" id="cardLastWeekValue">R$ 0,00</p>
                                </div>
                                <div class="p-2 bg-yellow-500/10 rounded-lg text-yellow-500 group-hover:bg-yellow-500 group-hover:text-white transition-colors"><i class="fa-solid fa-clock-rotate-left"></i></div>
                            </div>
                        </div>
                        <div class="bg-brand-panel p-4 rounded-xl border border-[var(--border-color)] shadow hover:border-purple-400/50 transition-all group">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-400 text-xs font-semibold mb-1">M√™s Passado</p>
                                    <h3 class="text-2xl font-bold text-brand-text" id="cardLastMonthCount">0</h3>
                                    <p class="text-xs text-gray-500 mt-1" id="cardLastMonthValue">R$ 0,00</p>
                                </div>
                                <div class="p-2 bg-purple-500/10 rounded-lg text-purple-500 group-hover:bg-purple-500 group-hover:text-white transition-colors"><i class="fa-regular fa-calendar-xmark"></i></div>
                            </div>
                        </div>
                        <div class="bg-brand-panel p-4 rounded-xl border border-[var(--border-color)] shadow hover:border-cyan-400/50 transition-all group">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-400 text-xs font-semibold mb-1">Este Ano</p>
                                    <h3 class="text-2xl font-bold text-brand-text" id="cardYearCount">0</h3>
                                    <p class="text-xs text-gray-500 mt-1" id="cardYearValue">R$ 0,00</p>
                                </div>
                                <div class="p-2 bg-cyan-500/10 rounded-lg text-cyan-500 group-hover:bg-cyan-500 group-hover:text-white transition-colors"><i class="fa-solid fa-earth-americas"></i></div>
                            </div>
                        </div>
                        <!-- NOVO CARD: ANO PASSADO -->
                        <div class="bg-brand-panel p-4 rounded-xl border border-[var(--border-color)] shadow hover:border-indigo-400/50 transition-all group">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-400 text-xs font-semibold mb-1">Ano Passado</p>
                                    <h3 class="text-2xl font-bold text-brand-text" id="cardLastYearCount">0</h3>
                                    <p class="text-xs text-gray-500 mt-1" id="cardLastYearValue">R$ 0,00</p>
                                </div>
                                <div class="p-2 bg-indigo-500/10 rounded-lg text-indigo-500 group-hover:bg-indigo-500 group-hover:text-white transition-colors"><i class="fa-solid fa-calendar-days"></i></div>
                            </div>
                        </div>
                        
                        <div class="bg-brand-panel p-4 rounded-xl border border-[var(--border-color)] shadow hover:border-orange-400/50 transition-all group">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-400 text-xs font-semibold mb-1">M√™s Antepassado</p>
                                    <h3 class="text-2xl font-bold text-brand-text" id="cardMonthBeforeLastCount">0</h3>
                                    <p class="text-xs text-gray-500 mt-1" id="cardMonthBeforeLastValue">R$ 0,00</p>
                                </div>
                                <div class="p-2 bg-orange-500/10 rounded-lg text-orange-500 group-hover:bg-orange-500 group-hover:text-white transition-colors"><i class="fa-solid fa-backward"></i></div>
                            </div>
                        </div>
                    </div>

                    <!-- KPIs -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 animate-fade-in mt-8">
                        <div class="bg-brand-panel p-5 rounded-xl border border-[var(--border-color)] shadow-lg relative overflow-hidden group">
                            <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i class="fa-solid fa-sack-dollar text-6xl text-green-500"></i></div>
                            <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Total Hist√≥rico</p>
                            <h3 class="text-2xl font-bold text-brand-text mt-1" id="kpiTotalRevenue">R$ 0,00</h3>
                        </div>
                        <div class="bg-brand-panel p-5 rounded-xl border border-[var(--border-color)] shadow-lg relative overflow-hidden group">
                            <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i class="fa-solid fa-receipt text-6xl text-blue-500"></i></div>
                            <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Ticket M√©dio</p>
                            <h3 class="text-2xl font-bold text-brand-text mt-1" id="kpiAvgTicket">R$ 0,00</h3>
                        </div>
                        <div class="bg-brand-panel p-5 rounded-xl border border-[var(--border-color)] shadow-lg relative overflow-hidden group">
                            <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i class="fa-solid fa-trophy text-6xl text-yellow-500"></i></div>
                            <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Melhor M√™s</p>
                            <h3 class="text-lg font-bold text-brand-text mt-1 truncate" id="kpiBestMonth">---</h3>
                            <p class="text-xs text-yellow-500 font-mono" id="kpiBestMonthValue">R$ 0,00</p>
                        </div>
                        <div class="bg-brand-panel p-5 rounded-xl border border-[var(--border-color)] shadow-lg relative overflow-hidden group">
                            <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i class="fa-solid fa-arrow-trend-down text-6xl text-red-500"></i></div>
                            <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Pior M√™s</p>
                            <h3 class="text-lg font-bold text-brand-text mt-1 truncate" id="kpiWorstMonth">---</h3>
                            <p class="text-xs text-red-500 font-mono" id="kpiWorstMonthValue">R$ 0,00</p>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-brand-panel p-6 rounded-xl border border-[var(--border-color)] shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-brand-text">Evolu√ß√£o de Vendas</h3>
                                <select id="yearFilter" onchange="window.updateCharts()" class="bg-gray-800 text-xs text-white border border-gray-700 rounded p-1">
                                    <option value="all">Todo o Per√≠odo</option>
                                </select>
                            </div>
                            <div class="relative h-72 w-full">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-brand-panel p-6 rounded-xl border border-[var(--border-color)] shadow-lg flex flex-col">
                            <h3 class="text-lg font-bold text-brand-text mb-4">Top Servi√ßos</h3>
                            <div class="relative h-48 w-full mb-4">
                                <canvas id="servicesChart"></canvas>
                            </div>
                            <div class="mt-auto space-y-2" id="topServicesList"></div>
                        </div>
                    </div>
                    
                    <!-- Table Section -->
                    <div class="bg-brand-panel rounded-xl border border-[var(--border-color)] shadow-lg overflow-hidden flex flex-col max-h-[600px]">
                        <div class="p-6 border-b border-[var(--border-color)] flex flex-col md:flex-row justify-between items-center gap-4">
                            <h3 class="text-lg font-bold text-brand-text">Hist√≥rico de Transa√ß√µes</h3>
                            <div class="flex gap-2 w-full md:w-auto">
                                <input type="text" id="tableSearch" onkeyup="window.renderTable()" placeholder="Buscar..." class="bg-gray-900 border border-gray-700 text-white text-sm rounded-lg px-3 py-2 w-full focus:border-brand-accent outline-none">
                            </div>
                        </div>
                        <div class="overflow-auto flex-1">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-black/20 text-xs text-gray-500 uppercase sticky top-0 backdrop-blur-sm z-10">
                                    <tr>
                                        <th class="p-4 font-semibold border-b border-gray-800">Data</th>
                                        <th class="p-4 font-semibold border-b border-gray-800">Cliente / Empresa</th>
                                        <th class="p-4 font-semibold border-b border-gray-800">Servi√ßo</th>
                                        <th class="p-4 font-semibold border-b border-gray-800">Contato</th>
                                        <th class="p-4 font-semibold border-b border-gray-800">Valor</th>
                                        <th class="p-4 font-semibold border-b border-gray-800 text-center">Status</th>
                                        <th class="p-4 font-semibold border-b border-gray-800 text-right">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="dataTableBody" class="text-sm text-gray-300 divide-y divide-gray-800"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- CLIENTES -->
                <div id="view-clients" class="tab-content space-y-6">
                    
                    <!-- Dashboard Resumo CRM -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="bg-brand-panel border-l-4 border-blue-500 p-4 rounded-lg shadow-lg">
                            <h3 class="text-xs uppercase text-gray-400 font-bold">Total Realizando</h3>
                            <p id="totalRealizando" class="text-2xl font-bold text-blue-400">0</p>
                        </div>
                        <div class="bg-brand-panel border-l-4 border-green-500 p-4 rounded-lg shadow-lg">
                            <h3 class="text-xs uppercase text-gray-400 font-bold">Total Entregue</h3>
                            <p id="totalEntregue" class="text-2xl font-bold text-green-400">0</p>
                        </div>
                        <div class="bg-brand-panel border-l-4 border-gray-500 p-4 rounded-lg shadow-lg">
                            <h3 class="text-xs uppercase text-gray-400 font-bold">Total de Projetos</h3>
                            <p id="totalClientes" class="text-2xl font-bold text-brand-text">0</p>
                        </div>
                        <div class="bg-brand-panel border-l-4 border-brand-accent p-4 rounded-lg shadow-lg">
                            <h3 class="text-xs uppercase text-gray-400 font-bold">Total em Valor</h3>
                            <p id="totalValor" class="text-2xl font-bold text-brand-text">R$ 0,00</p>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                        <div class="flex items-center gap-2 w-full md:w-auto flex-1">
                            <input type="text" id="buscarCliente" placeholder="üîç Buscar clientes..." onkeyup="window.renderClientsCards(true)" class="p-3 bg-gray-900 border border-gray-700 rounded-lg w-full text-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none" />
                        </div>
                        
                        <div class="flex flex-wrap gap-2 w-full md:w-auto">
                            <select id="filtroStatus" onchange="window.renderClientsCards(true)" class="p-3 bg-gray-900 border border-gray-700 text-white rounded-lg w-full md:w-auto cursor-pointer hover:bg-gray-800 transition">
                                <option value="">Situa√ß√£o</option>
                                <option value="realizando">Realizando</option>
                                <option value="entregue">Entregue</option>
                            </select>
                            <select id="filtroServico" onchange="window.renderClientsCards(true)" class="p-3 bg-gray-900 border border-gray-700 text-white rounded-lg w-full md:w-auto cursor-pointer hover:bg-gray-800 transition">
                                <option value="">Servi√ßo</option>
                                <option value="logotipo">Logotipo</option>
                                <option value="site">Site</option>
                                <option value="anuncio">An√∫ncio</option>
                            </select>
                            <select id="filtroPrioridade" onchange="window.renderClientsCards(true)" class="p-3 bg-gray-900 border border-gray-700 text-white rounded-lg w-full md:w-auto cursor-pointer hover:bg-gray-800 transition">
                                <option value="">Prioridade</option>
                                <option value="baixa">Baixa</option>
                                <option value="m√©dia">M√©dia</option>
                                <option value="alta">Alta</option>
                            </select>
                        </div>
                    </div>

                    <!-- Cards Grid -->
                    <div id="listaClientes" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 pb-6">
                        <!-- Cards injetados via JS -->
                    </div>

                    <!-- Controles de Pagina√ß√£o -->
                    <div id="paginationControls" class="flex justify-center items-center gap-2 pb-20 pt-4">
                        <!-- Bot√µes de pagina√ß√£o injetados via JS -->
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL: CLIENTE -->
    <!-- Ajustado com max-h-[90vh] e overflow-y-auto para n√£o estourar tela mobile -->
    <div id="modalCliente" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center z-[60] p-4 transition-all duration-300">
        <div class="bg-brand-panel border border-gray-700 p-4 sm:p-8 rounded-xl shadow-2xl w-full max-w-2xl transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-6 text-brand-text flex items-center gap-2">
                <i class="fa-solid fa-user-pen text-blue-500"></i> Adicionar / Editar Cliente
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1">Nome / Cliente</label>
                    <input id="nomeCliente" class="bg-gray-900 border border-gray-700 text-white p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 outline-none" type="text" placeholder="Ex: Jo√£o Silva">
                </div>
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1">Empresa</label>
                    <input id="empresaCliente" class="bg-gray-900 border border-gray-700 text-white p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 outline-none" type="text" placeholder="Ex: Padaria X">
                </div>
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1">Contato</label>
                    <input id="contatoCliente" class="bg-gray-900 border border-gray-700 text-white p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 outline-none" type="text" placeholder="WhatsApp ou Email">
                </div>
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1">Valor (R$)</label>
                    <input id="valorCliente" class="bg-gray-900 border border-gray-700 text-white p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 outline-none" type="number" step="0.01" placeholder="0.00">
                </div>

                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1">Servi√ßo</label>
                    <select id="tipoServico" class="bg-gray-900 border border-gray-700 text-white p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="">Selecione...</option>
                        <option value="logotipo">Logotipo</option>
                        <option value="site">Site</option>
                        <option value="anuncio">An√∫ncio</option>
                        <option value="flyer">Flyer</option>
                        <option value="video">V√≠deo</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1">Prioridade</label>
                    <select id="prioridadeCliente" class="bg-gray-900 border border-gray-700 text-white p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="baixa">Baixa</option>
                        <option value="m√©dia" selected>M√©dia</option>
                        <option value="alta">Alta</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1">Status</label>
                    <select id="statusCliente" class="bg-gray-900 border border-gray-700 text-white p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="realizando">Realizando</option>
                        <option value="entregue">Entregue</option>
                        <option value="pendente">Pendente</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1">Data</label>
                    <input id="dataCriacao" class="bg-gray-900 border border-gray-700 text-white p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 outline-none" type="date">
                </div>
                <div class="md:col-span-2">
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1">Observa√ß√µes</label>
                    <textarea id="obsCliente" class="bg-gray-900 border border-gray-700 text-white p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 outline-none" rows="3" placeholder="Detalhes do projeto..."></textarea>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row justify-end gap-3 mt-6 pt-4 border-t border-gray-700">
                <button onclick="window.fecharModal()" class="bg-transparent border border-gray-600 text-gray-300 px-6 py-2 rounded-lg hover:bg-gray-800 transition">Cancelar</button>
                <button onclick="window.salvarCliente()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition font-bold shadow-lg shadow-blue-900/40">Salvar Cliente</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT TIPO MODULE PARA IMPORTA√á√ÉO DO FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
        import { getDatabase, ref, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyBnzLylJjDRIhAOxhH52MwFYe-sL9-NUb4",
          authDomain: "crm90-cb5e0.firebaseapp.com",
          databaseURL: "https://crm90-cb5e0-default-rtdb.firebaseio.com",
          projectId: "crm90-cb5e0",
          storageBucket: "crm90-cb5e0.firebasestorage.app",
          messagingSenderId: "142520873560",
          appId: "1:142520873560:web:2dfd3dc34f4bdb7c51502d",
          measurementId: "G-S6WB9X9VQ5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase(app);
        const DB_PATH = 'wa_growth_data_v2'; // Caminho no Realtime DB

        // --- CONSTANTES E ESTADO ---
        let appData = []; 
        let editando = false;
        let clienteIdAtual = null;
        let currentPage = 1; // P√°gina atual da pagina√ß√£o
        const itemsPerPage = 15; // Itens por p√°gina

        let charts = { revenue: null, services: null };
        let sortableInstance = null; // Inst√¢ncia global do Sortable

        // --- INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', () => {
            initFirebaseListener(); // Substitui loadData local
            initDate();
        });

        // --- FIREBASE LISTENERS ---
        function initFirebaseListener() {
            const dataRef = ref(db, DB_PATH);
            onValue(dataRef, (snapshot) => {
                const data = snapshot.val();
                if (data && Array.isArray(data)) {
                    appData = data;
                } else if (data) {
                    // Caso venha como objeto (comum se usar push, mas estamos salvando array)
                    appData = Object.values(data); 
                } else {
                    appData = [];
                }
                refreshDashboard();
            });
        }

        function saveDataToFirebase() {
            // Salva o estado atual do appData no Firebase
            set(ref(db, DB_PATH), appData)
                .catch((error) => console.error("Erro ao salvar no Firebase:", error));
        }

        // --- FUN√á√ïES GLOBAIS (ATTACH WINDOW) ---
        // Como 'type="module"' isola o escopo, precisamos anexar ao window para o HTML acessar

        window.initDate = initDate;
        window.toggleTheme = toggleTheme;
        window.switchTab = switchTab;
        window.resetData = resetData;
        window.exportData = exportData;
        window.handleFileImport = handleFileImport;
        window.renderClientsCards = renderClientsCards;
        window.abrirModalNovoCliente = abrirModalNovoCliente;
        window.fecharModal = fecharModal;
        window.salvarCliente = salvarCliente;
        window.editarCliente = editarCliente;
        window.excluirCliente = excluirCliente;
        window.renderTable = renderTable;
        window.deleteItem = deleteItem;
        window.updateCharts = updateCharts;
        window.toggleSidebar = toggleSidebar; 
        window.changePage = changePage; // Fun√ß√£o de pagina√ß√£o

        function initDate() {
            const date = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateStr = date.toLocaleDateString('pt-BR', options);
            document.getElementById('currentDate').textContent = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
        }

        // --- TEMA (BLUE LIGHT MODE) ---
        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('themeIcon');
            
            body.classList.toggle('light-mode');
            
            if (body.classList.contains('light-mode')) {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            } else {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            }
        }
        
        // --- SIDEBAR TOGGLE (Mobile) ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.toggle('mobile-open');
            if (sidebar.classList.contains('mobile-open')) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        // --- NAVEGA√á√ÉO ENTRE ABAS ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('btn-dashboard').className = "w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-brand-text hover:bg-gray-800/20 rounded-lg border-l-4 border-transparent transition-all text-left";
            document.getElementById('btn-clients').className = "w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-brand-text hover:bg-gray-800/20 rounded-lg border-l-4 border-transparent transition-all text-left";

            if(tabName === 'dashboard') {
                document.getElementById('view-dashboard').classList.add('active');
                document.getElementById('btn-dashboard').className = "w-full flex items-center gap-3 px-4 py-3 bg-brand-accent/10 text-brand-accent rounded-lg border-l-4 border-brand-accent transition-all text-left";
            } else if(tabName === 'clients') {
                document.getElementById('view-clients').classList.add('active');
                document.getElementById('btn-clients').className = "w-full flex items-center gap-3 px-4 py-3 bg-brand-accent/10 text-brand-accent rounded-lg border-l-4 border-brand-accent transition-all text-left";
                renderClientsCards(); 
            }
        }

        // --- GEST√ÉO DE DADOS ---
        // (loadData removido em favor do initFirebaseListener)

        function resetData() {
            if(confirm("ATEN√á√ÉO: Isso apagar√° TODOS os dados do sistema permanentemente no Firebase. Deseja continuar?")) {
                set(ref(db, DB_PATH), [])
                    .then(() => alert("Sistema resetado com sucesso."))
                    .catch((err) => alert("Erro ao resetar: " + err));
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_wa_comercial_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function handleFileImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        if(confirm(`Arquivo lido com ${importedData.length} registros. Deseja SUBSTITUIR os dados atuais (OK) ou MESCLAR (Cancelar)?`)) {
                            appData = importedData;
                        } else {
                            const currentIds = new Set(appData.map(i => i.id));
                            let addedCount = 0;
                            importedData.forEach(item => {
                                if(!currentIds.has(item.id)) {
                                    appData.push(item);
                                    addedCount++;
                                }
                            });
                            alert(`${addedCount} novos registros adicionados.`);
                        }
                        saveDataToFirebase(); // Salva no Firebase
                        alert("Importa√ß√£o conclu√≠da e sincronizada!");
                    } else {
                        alert("Formato de JSON inv√°lido.");
                    }
                } catch (err) {
                    console.error(err);
                    alert("Erro ao ler o arquivo JSON.");
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // --- L√ìGICA DO DASHBOARD ---
        function refreshDashboard() {
            updateKPIs();
            renderTable();
            updateCharts();
            document.getElementById('totalRecordsBadge').textContent = `${appData.length} Registros`;
            
            if(document.getElementById('view-clients').classList.contains('active')) {
                renderClientsCards();
            }
        }

        // --- L√ìGICA DA ABA CLIENTES ---
        function renderClientsCards(resetPage = false) {
            if (resetPage) currentPage = 1; // Reseta para a primeira p√°gina se solicitado (filtros)

            const listaClientes = document.getElementById('listaClientes');
            listaClientes.innerHTML = '';

            const busca = document.getElementById('buscarCliente').value.toLowerCase().trim();
            const fs = document.getElementById('filtroStatus').value.toLowerCase();
            const ft = document.getElementById('filtroServico').value.toLowerCase();
            const fp = document.getElementById('filtroPrioridade').value.toLowerCase();

            let totalValor = 0;
            let totalRealizando = 0;
            let totalEntregue = 0;
            let totalExibido = 0;

            let filtrados = appData.filter(cliente => {
                const s = (cliente.status || '').toLowerCase();
                const t = (cliente.tipo || '').toLowerCase();
                const p = (cliente.prioridade || 'm√©dia').toLowerCase();
                const n = (cliente.nome || '').toLowerCase();
                const e = (cliente.empresa || '').toLowerCase();

                if (fs && s !== fs) return false;
                if (ft && !t.includes(ft)) return false; 
                if (fp && p !== fp) return false;
                if (busca && !n.includes(busca) && !e.includes(busca)) return false;
                
                return true;
            });

            // Ordena√ß√£o do Sortable (manual) √© preservada pois o appData vem na ordem do Firebase

            // L√≥gica de Pagina√ß√£o
            const totalItems = filtrados.length;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedItems = filtrados.slice(startIndex, endIndex);

            // Renderiza os cards apenas da p√°gina atual
            paginatedItems.forEach(cliente => {
                // C√°lculos de totais s√£o feitos sobre os FILTRADOS, n√£o apenas paginados, para o resumo
                // Mas aqui dentro do forEach s√≥ estamos iterando paginados.
                // Ajuste: Totais devem ser calculados sobre "filtrados" antes de paginar.
            });

            // Recalcula totais usando a lista completa filtrada (para os KPIs do topo da aba Clientes ficarem corretos)
            filtrados.forEach(cliente => {
                totalValor += (parseFloat(cliente.valor) || 0);
                totalExibido++;
                const st = (cliente.status || '').toLowerCase();
                if (st === 'realizando') totalRealizando++;
                if (st === 'entregue') totalEntregue++;
            });

            // Renderiza Cards PAGINADOS
            paginatedItems.forEach(cliente => {
                const st = (cliente.status || '').toLowerCase();
                const fundoStatus = st === 'entregue' ? 'bg-entregue' :
                                    st === 'realizando' ? 'bg-realizando' : 'bg-gray-800 text-gray-300';
                
                let prioridadeClasse = 'borda-status-neutro';
                if (st === 'realizando') prioridadeClasse = 'borda-status-realizando';
                else if (st === 'entregue') prioridadeClasse = 'borda-status-entregue';
                
                const card = document.createElement('div');
                card.setAttribute('data-id', cliente.id);
                
                card.className = `bg-brand-panel border border-gray-800 border-l-[6px] ${prioridadeClasse} rounded-lg p-3 card-animado relative group shadow-sm hover:shadow-md flex flex-col justify-between h-auto`;

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1 min-w-0 pr-2">
                            <h3 class="text-base font-bold text-white truncate" title="${cliente.nome}">${cliente.nome || 'Sem Nome'}</h3>
                            <div class="flex items-center gap-2 text-brand-accent text-xs">
                                <i class="fa-regular fa-building"></i>
                                <span class="truncate max-w-[150px]" title="${cliente.empresa}">${cliente.empresa || 'Particular'}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-white">${formatCurrency(cliente.valor)}</p>
                            <p class="text-[10px] text-gray-500 uppercase tracking-wider">${cliente.tipo || 'Servi√ßo'}</p>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mt-1">
                        <div class="flex items-center gap-3 text-xs text-gray-400">
                             <div class="flex items-center gap-1" title="Contato">
                                <i class="fa-brands fa-whatsapp text-green-500"></i>
                                <span class="font-mono max-w-[80px] truncate">${cliente.contato || '-'}</span>
                             </div>
                             <span class="text-gray-600">|</span>
                             <span title="Data">${formatDate(cliente.data)}</span>
                        </div>

                        <div class="flex items-center gap-2">
                             <span class="${fundoStatus} text-[10px] px-2 py-0.5 rounded uppercase font-bold tracking-wide border border-opacity-20 flex items-center gap-1">
                                ${st === 'realizando' ? '' : ''} 
                                ${st === 'entregue' ? '<i class="fa-solid fa-check"></i>' : ''}
                                ${cliente.status || 'ND'}
                             </span>
                             
                             <div class="flex gap-1 ml-1">
                                <button onclick="editarCliente('${cliente.id}')" class="w-6 h-6 rounded bg-gray-800 hover:bg-gray-700 flex items-center justify-center text-gray-400 hover:text-white transition-colors">
                                    <i class="fa-solid fa-pen text-[10px]"></i>
                                </button>
                                <button onclick="excluirCliente('${cliente.id}')" class="w-6 h-6 rounded bg-red-500/10 hover:bg-red-500/20 flex items-center justify-center text-red-500 transition-colors">
                                    <i class="fa-solid fa-trash-can text-[10px]"></i>
                                </button>
                             </div>
                        </div>
                    </div>
                `;

                listaClientes.appendChild(card);
            });

            document.getElementById('totalRealizando').innerText = totalRealizando;
            document.getElementById('totalEntregue').innerText = totalEntregue;
            document.getElementById('totalClientes').innerText = totalExibido;
            document.getElementById('totalValor').innerText = formatCurrency(totalValor);

            renderPagination(totalItems);

            // Inicializar Sortable (apenas para a p√°gina atual)
            // Nota: Drag and Drop com pagina√ß√£o move itens apenas na view atual e salva essa ordem relativa no banco.
            if (!sortableInstance) {
                const el = document.getElementById('listaClientes');
                sortableInstance = Sortable.create(el, {
                    animation: 150,
                    handle: '.card-animado',
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    onEnd: function (evt) {
                        const itemEl = evt.item;
                        const newIndex = evt.newIndex;
                        const movedId = itemEl.getAttribute('data-id');
                        
                        // Recria a lista de IDs vis√≠veis
                        const visibleIds = Array.from(el.children).map(child => child.getAttribute('data-id'));
                        
                        // Encontra o item original no appData
                        const originalIndex = appData.findIndex(i => i.id === movedId);
                        if (originalIndex > -1) {
                            const movedItem = appData[originalIndex];
                            
                            // Remove da posi√ß√£o antiga
                            appData.splice(originalIndex, 1);

                            // L√≥gica Simplificada para Inser√ß√£o no Contexto Paginado:
                            // Se movemos visualmente para a posi√ß√£o X na p√°gina, precisamos encontrar o ID vizinho no array global
                            // Para simplificar: movemos para logo antes do item que agora est√° abaixo dele, ou depois do anterior.
                            
                            // Mas com pagina√ß√£o e filtro, o √≠ndice visual n√£o mapeia diretamente para o √≠ndice global.
                            // A melhor abordagem UX com pagina√ß√£o + filtro √© desativar ordena√ß√£o drag&drop ou apenas reordenar visualmente sem persist√™ncia complexa.
                            // Vou usar uma l√≥gica de inser√ß√£o baseada no ID vizinho mais pr√≥ximo que existe no array global.
                            
                            let targetId;
                            let insertAfter = false;

                            if (visibleIds.length > 1) {
                                // Se moveu para o final da lista vis√≠vel
                                if (newIndex === visibleIds.length - 1) {
                                    targetId = visibleIds[newIndex - 1]; // Item anterior
                                    insertAfter = true;
                                } else {
                                    targetId = visibleIds[newIndex + 1]; // Item seguinte (agora na posi√ß√£o dele ou depois)
                                    insertAfter = false; // Inserir antes
                                }
                                
                                const targetGlobalIndex = appData.findIndex(i => i.id === targetId);
                                if (targetGlobalIndex !== -1) {
                                    const insertPos = insertAfter ? targetGlobalIndex + 1 : targetGlobalIndex;
                                    appData.splice(insertPos, 0, movedItem);
                                } else {
                                    // Fallback
                                    appData.unshift(movedItem);
                                }
                            } else {
                                appData.unshift(movedItem);
                            }

                            saveDataToFirebase(); 
                        }
                    }
                });
            }
        }

        // Fun√ß√£o para Renderizar Controles de Pagina√ß√£o
        function renderPagination(totalItems) {
            const paginationContainer = document.getElementById('paginationControls');
            paginationContainer.innerHTML = '';

            const totalPages = Math.ceil(totalItems / itemsPerPage);

            if (totalPages <= 1) return; // N√£o mostra se s√≥ tiver 1 p√°gina

            // Bot√£o Anterior
            const prevBtn = document.createElement('button');
            prevBtn.innerHTML = '<i class="fa-solid fa-chevron-left"></i>';
            prevBtn.className = `w-8 h-8 rounded-lg flex items-center justify-center transition-colors ${currentPage === 1 ? 'text-gray-600 cursor-not-allowed' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`;
            prevBtn.onclick = () => { if(currentPage > 1) changePage(currentPage - 1); };
            paginationContainer.appendChild(prevBtn);

            // N√∫meros
            // L√≥gica simples: mostra todos se forem poucos, ou janela deslizante
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.innerText = i;
                if (i === currentPage) {
                    pageBtn.className = "w-8 h-8 rounded-lg bg-brand-accent text-white font-bold shadow-lg shadow-red-900/40";
                } else {
                    pageBtn.className = "w-8 h-8 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors";
                    pageBtn.onclick = () => changePage(i);
                }
                paginationContainer.appendChild(pageBtn);
            }

            // Bot√£o Pr√≥ximo
            const nextBtn = document.createElement('button');
            nextBtn.innerHTML = '<i class="fa-solid fa-chevron-right"></i>';
            nextBtn.className = `w-8 h-8 rounded-lg flex items-center justify-center transition-colors ${currentPage === totalPages ? 'text-gray-600 cursor-not-allowed' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`;
            nextBtn.onclick = () => { if(currentPage < totalPages) changePage(currentPage + 1); };
            paginationContainer.appendChild(nextBtn);
        }

        function changePage(newPage) {
            currentPage = newPage;
            renderClientsCards(false); // N√£o reseta para p√°gina 1, mant√©m a navega√ß√£o
        }

        // --- MODAL E CRUD ---
        function abrirModalNovoCliente() {
            limparFormulario();
            editando = false;
            clienteIdAtual = null;
            const modal = document.getElementById('modalCliente');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('dataCriacao').valueAsDate = new Date();
        }

        function fecharModal() {
            const modal = document.getElementById('modalCliente');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function salvarCliente() {
            const novoCliente = obterDadosFormulario();
            
            if (!novoCliente.nome && !novoCliente.empresa) {
                alert("Por favor, preencha o Nome ou a Empresa.");
                return;
            }

            if (editando && clienteIdAtual) {
                const index = appData.findIndex(c => c.id === clienteIdAtual);
                if (index !== -1) {
                    appData[index] = { ...appData[index], ...novoCliente };
                }
            } else {
                novoCliente.id = crypto.randomUUID();
                appData.unshift(novoCliente); // Adiciona no topo por padr√£o
            }

            saveDataToFirebase(); // Substitui o saveData local
            fecharModal();
        }

        function editarCliente(id) {
            const cliente = appData.find(c => c.id === id);
            if (cliente) {
                preencherFormulario(cliente);
                editando = true;
                clienteIdAtual = id;
                const modal = document.getElementById('modalCliente');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        function excluirCliente(id) {
            if (confirm("Tem certeza que deseja remover este cliente/projeto?")) {
                appData = appData.filter(c => c.id !== id);
                saveDataToFirebase();
            }
        }

        function obterDadosFormulario() {
            return {
                nome: document.getElementById('nomeCliente').value,
                empresa: document.getElementById('empresaCliente').value,
                contato: document.getElementById('contatoCliente').value,
                valor: parseFloat(document.getElementById('valorCliente').value) || 0,
                tipo: document.getElementById('tipoServico').value,
                prioridade: document.getElementById('prioridadeCliente').value,
                status: document.getElementById('statusCliente').value,
                data: document.getElementById('dataCriacao').value,
                obs: document.getElementById('obsCliente').value
            };
        }

        function preencherFormulario(cliente) {
            document.getElementById('nomeCliente').value = cliente.nome || '';
            document.getElementById('empresaCliente').value = cliente.empresa || '';
            document.getElementById('contatoCliente').value = cliente.contato || '';
            document.getElementById('valorCliente').value = cliente.valor || '';
            document.getElementById('tipoServico').value = cliente.tipo || '';
            document.getElementById('prioridadeCliente').value = cliente.prioridade || 'baixa';
            document.getElementById('statusCliente').value = cliente.status || 'realizando';
            document.getElementById('dataCriacao').value = cliente.data || '';
            document.getElementById('obsCliente').value = cliente.obs || '';
        }

        function limparFormulario() {
            document.querySelectorAll('#modalCliente input, #modalCliente select, #modalCliente textarea')
                .forEach(el => el.value = '');
            document.getElementById('prioridadeCliente').value = 'm√©dia';
            document.getElementById('statusCliente').value = 'realizando';
        }

        // --- CALCULOS E KPI ---
        function calculatePeriodStats(startDate, endDate) {
            const parseLocal = (dateStr) => {
                const [y, m, d] = dateStr.split('-').map(Number);
                return new Date(y, m - 1, d, 0, 0, 0, 0);
            };
            const parseLocalEnd = (dateStr) => {
                const [y, m, d] = dateStr.split('-').map(Number);
                return new Date(y, m - 1, d, 23, 59, 59, 999);
            };
            const start = parseLocal(startDate);
            const end = parseLocalEnd(endDate);
            let count = 0;
            let total = 0;
            appData.forEach(item => {
                if(!item.data) return;
                const [y, m, d] = item.data.split('-').map(Number);
                const itemDate = new Date(y, m - 1, d);
                if (itemDate.getTime() >= start.getTime() && itemDate.getTime() <= end.getTime()) {
                    count++;
                    total += (parseFloat(item.valor) || 0);
                }
            });
            return { count, total };
        }

        function updateKPIs() {
            if (appData.length === 0) {
                resetKPIs();
                return;
            }
            const now = new Date();
            const formatDateISO = (date) => {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            };
            const todayStr = formatDateISO(now);
            const yesterdayDate = new Date(now);
            yesterdayDate.setDate(now.getDate() - 1);
            const yesterdayStr = formatDateISO(yesterdayDate);
            const currentDay = now.getDay();
            const daysToMonday = (currentDay + 6) % 7; 
            const thisWeekStart = new Date(now);
            thisWeekStart.setDate(now.getDate() - daysToMonday);
            const thisWeekEnd = new Date(thisWeekStart);
            thisWeekEnd.setDate(thisWeekStart.getDate() + 6);
            const lastWeekStart = new Date(thisWeekStart);
            lastWeekStart.setDate(thisWeekStart.getDate() - 7);
            const lastWeekEnd = new Date(lastWeekStart);
            lastWeekEnd.setDate(lastWeekStart.getDate() + 6);
            const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const thisMonthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
            const monthBeforeLastStart = new Date(now.getFullYear(), now.getMonth() - 2, 1);
            const monthBeforeLastEnd = new Date(now.getFullYear(), now.getMonth() - 1, 0);
            const thisYearStart = new Date(now.getFullYear(), 0, 1);
            const thisYearEnd = new Date(now.getFullYear(), 11, 31);
            
            // --- C√ÅLCULO DE ANO PASSADO ---
            const lastYearStart = new Date(now.getFullYear() - 1, 0, 1);
            const lastYearEnd = new Date(now.getFullYear() - 1, 11, 31);

            const statsToday = calculatePeriodStats(todayStr, todayStr);
            const statsYesterday = calculatePeriodStats(yesterdayStr, yesterdayStr);
            const statsThisWeek = calculatePeriodStats(formatDateISO(thisWeekStart), formatDateISO(thisWeekEnd));
            const statsLastWeek = calculatePeriodStats(formatDateISO(lastWeekStart), formatDateISO(lastWeekEnd));
            const statsThisMonth = calculatePeriodStats(formatDateISO(thisMonthStart), formatDateISO(thisMonthEnd));
            const statsLastMonth = calculatePeriodStats(formatDateISO(lastMonthStart), formatDateISO(lastMonthEnd));
            const statsMonthBeforeLast = calculatePeriodStats(formatDateISO(monthBeforeLastStart), formatDateISO(monthBeforeLastEnd));
            const statsThisYear = calculatePeriodStats(formatDateISO(thisYearStart), formatDateISO(thisYearEnd));
            const statsLastYear = calculatePeriodStats(formatDateISO(lastYearStart), formatDateISO(lastYearEnd));

            updateCard('cardToday', statsToday);
            updateCard('cardYesterday', statsYesterday);
            updateCard('cardWeek', statsThisWeek);
            updateCard('cardLastWeek', statsLastWeek);
            updateCard('cardMonth', statsThisMonth);
            updateCard('cardLastMonth', statsLastMonth);
            updateCard('cardMonthBeforeLast', statsMonthBeforeLast);
            updateCard('cardYear', statsThisYear);
            updateCard('cardLastYear', statsLastYear); 

            const totalRevenue = appData.reduce((acc, curr) => acc + (parseFloat(curr.valor) || 0), 0);
            const avgTicket = totalRevenue / appData.length;
            const monthlyStats = {};
            appData.forEach(item => {
                if(!item.data) return;
                const dateKey = item.data.substring(0, 7); 
                if(!monthlyStats[dateKey]) monthlyStats[dateKey] = 0;
                monthlyStats[dateKey] += (parseFloat(item.valor) || 0);
            });
            let bestMonth = { key: '', val: -Infinity };
            let worstMonth = { key: '', val: Infinity };
            Object.entries(monthlyStats).forEach(([key, val]) => {
                if(val > bestMonth.val) bestMonth = { key, val };
                if(val < worstMonth.val) worstMonth = { key, val };
            });
            document.getElementById('kpiTotalRevenue').innerText = formatCurrency(totalRevenue);
            document.getElementById('kpiAvgTicket').innerText = formatCurrency(avgTicket);
            if (Object.keys(monthlyStats).length > 0) {
                document.getElementById('kpiBestMonth').innerText = formatDateToMonthYear(bestMonth.key);
                document.getElementById('kpiBestMonthValue').innerText = formatCurrency(bestMonth.val);
                document.getElementById('kpiWorstMonth').innerText = formatDateToMonthYear(worstMonth.key);
                document.getElementById('kpiWorstMonthValue').innerText = formatCurrency(worstMonth.val);
            }
        }

        function updateCard(prefix, stats) {
            document.getElementById(`${prefix}Count`).innerText = stats.count;
            document.getElementById(`${prefix}Value`).innerText = formatCurrency(stats.total);
        }

        function resetKPIs() {
            const ids = ['cardToday', 'cardYesterday', 'cardWeek', 'cardLastWeek', 'cardMonth', 'cardLastMonth', 'cardMonthBeforeLast', 'cardYear', 'cardLastYear'];
            ids.forEach(id => updateCard(id, {count: 0, total: 0}));
            document.getElementById('kpiTotalRevenue').innerText = "R$ 0,00";
            document.getElementById('kpiAvgTicket').innerText = "R$ 0,00";
            document.getElementById('kpiBestMonth').innerText = "---";
            document.getElementById('kpiWorstMonth').innerText = "---";
        }

        // --- TABELA DASHBOARD ---
        function renderTable() {
            const tbody = document.getElementById('dataTableBody');
            const searchTerm = document.getElementById('tableSearch').value.toLowerCase();
            tbody.innerHTML = '';
            const filteredData = appData
                .filter(item => {
                    if(!searchTerm) return true;
                    return (item.nome || '').toLowerCase().includes(searchTerm) ||
                           (item.empresa || '').toLowerCase().includes(searchTerm) ||
                           (item.tipo || '').toLowerCase().includes(searchTerm);
                })
                .sort((a, b) => new Date(b.data) - new Date(a.data));
            const displayData = filteredData.slice(0, 50);
            displayData.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-800/50 transition-colors border-b border-[var(--border-color)] last:border-0";
                const statusStyle = getStatusStyle(item.status);
                const typeIcon = getTypeIcon(item.tipo);
                const displayClient = item.empresa || item.nome || 'Sem Nome';
                const subClient = item.empresa && item.nome && item.empresa !== item.nome ? item.nome : '';
                tr.innerHTML = `
                    <td class="p-4 text-gray-400 whitespace-nowrap">${formatDate(item.data)}</td>
                    <td class="p-4">
                        <div class="font-medium text-brand-text">${displayClient}</div>
                        ${subClient ? `<div class="text-xs text-gray-500">${subClient}</div>` : ''}
                    </td>
                    <td class="p-4"><span class="flex items-center gap-2 capitalize">${typeIcon} ${item.tipo || 'Geral'}</span></td>
                    <td class="p-4 text-xs font-mono text-gray-400">${item.contato || '-'}</td>
                    <td class="p-4 font-mono font-bold text-gray-300">${formatCurrency(item.valor)}</td>
                    <td class="p-4 text-center"><span class="text-xs px-2 py-1 rounded-full uppercase font-bold tracking-wide ${statusStyle}">${item.status || 'ND'}</span></td>
                    <td class="p-4 text-right">
                        <button onclick="deleteItem('${item.id}')" class="text-gray-600 hover:text-red-500 transition-colors p-2"><i class="fa-solid fa-trash-can"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- UTILS ---
        function deleteItem(id) {
            if(confirm('Tem certeza que deseja remover este registro?')) {
                appData = appData.filter(i => i.id !== id);
                saveDataToFirebase();
            }
        }

        function updateCharts() {
            if(appData.length === 0) return;
            const monthlyData = {};
            appData.forEach(item => {
                if(!item.data) return;
                const key = item.data.substring(0, 7); 
                if(!monthlyData[key]) monthlyData[key] = 0;
                monthlyData[key] += parseFloat(item.valor) || 0;
            });
            const sortedKeys = Object.keys(monthlyData).sort();
            const chartLabels = sortedKeys.map(k => formatDateToMonthYear(k));
            const chartValues = sortedKeys.map(k => monthlyData[k]);
            const ctxRev = document.getElementById('revenueChart').getContext('2d');
            if(charts.revenue) charts.revenue.destroy();
            const gradient = ctxRev.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(239, 68, 68, 0.5)');
            gradient.addColorStop(1, 'rgba(239, 68, 68, 0)');
            charts.revenue = new Chart(ctxRev, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Receita (R$)',
                        data: chartValues,
                        borderColor: '#ef4444',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointBackgroundColor: '#18181b',
                        pointBorderColor: '#ef4444',
                        pointRadius: 4,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#27272a' }, ticks: { color: '#71717a', callback: (val) => 'R$ ' + val } },
                        x: { grid: { display: false }, ticks: { color: '#71717a' } }
                    }
                }
            });
            const serviceCounts = {};
            appData.forEach(item => {
                const type = (item.tipo || 'Outros').toLowerCase();
                if(!serviceCounts[type]) serviceCounts[type] = 0;
                serviceCounts[type]++;
            });
            const sortedServices = Object.entries(serviceCounts).sort((a,b) => b[1] - a[1]).slice(0, 5); 
            const labelsPie = sortedServices.map(s => s[0].charAt(0).toUpperCase() + s[0].slice(1));
            const dataPie = sortedServices.map(s => s[1]);
            const listContainer = document.getElementById('topServicesList');
            listContainer.innerHTML = '';
            sortedServices.forEach(([name, count]) => {
                const percent = ((count / appData.length) * 100).toFixed(1);
                listContainer.innerHTML += `<div class="flex justify-between items-center text-sm"><span class="text-gray-400 capitalize">${name}</span><span class="text-brand-text font-bold">${count} <span class="text-xs text-gray-600">(${percent}%)</span></span></div>`;
            });
            const ctxServ = document.getElementById('servicesChart').getContext('2d');
            if(charts.services) charts.services.destroy();
            charts.services = new Chart(ctxServ, {
                type: 'doughnut',
                data: {
                    labels: labelsPie,
                    datasets: [{
                        data: dataPie,
                        backgroundColor: ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: { legend: { position: 'right', labels: { color: '#9ca3af', boxWidth: 10 } } }
                }
            });
        }

        function formatCurrency(val) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val || 0); }
        function formatDate(dateStr) { if(!dateStr) return '-'; const [y, m, d] = dateStr.split('-'); return `${d}/${m}/${y}`; }
        function formatDateToMonthYear(yyyy_mm) { if(!yyyy_mm) return '-'; const [y, m] = yyyy_mm.split('-'); const months = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez']; return `${months[parseInt(m)-1]} ${y}`; }
        function getStatusStyle(status) { status = (status || '').toLowerCase(); if(status === 'entregue') return 'bg-green-900/50 text-green-400 border border-green-900'; if(status === 'realizando') return 'bg-blue-900/50 text-blue-400 border border-blue-900'; if(status === 'pendente') return 'bg-yellow-900/50 text-yellow-400 border border-yellow-900'; if(status === 'cancelado') return 'bg-red-900/50 text-red-400 border border-red-900'; return 'bg-gray-700 text-gray-300'; }
        function getTypeIcon(type) { type = (type || '').toLowerCase(); if(type.includes('logo')) return '<i class="fa-solid fa-pen-nib text-purple-400"></i>'; if(type.includes('site') || type.includes('web')) return '<i class="fa-solid fa-globe text-blue-400"></i>'; if(type.includes('anuncio') || type.includes('traffic')) return '<i class="fa-solid fa-bullhorn text-red-400"></i>'; if(type.includes('video')) return '<i class="fa-solid fa-video text-pink-400"></i>'; return '<i class="fa-solid fa-box text-gray-400"></i>'; }

    </script>
</body>
</html>
